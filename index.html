<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0b" />
  <link rel="manifest" href="manifest.json" />
  <title>Zarya Finance</title>
  <style>
    :root{ --bg:#0a0a0a; --border:#2a2416; --text:#f6f4eb; --muted:#bdb6a3; --gold:#d4af37; --gold2:#c39a2b; --btn:#1a150b; --btnb:#3a2f16; --chip:#0f0d08; }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;margin:0;background:linear-gradient(180deg,#090909,#0f0f0f);color:var(--text)}
    header{position:sticky;top:0;background:rgba(16,16,16,.85);backdrop-filter: blur(6px);border-bottom:1px solid var(--border);padding:14px 16px;z-index:10}
    h1{font-size:18px;margin:0;letter-spacing:.3px}
    h1 .brand{color:var(--gold)}
    main{padding:16px;max-width:1040px;margin:0 auto}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 20px}
    nav button{background:var(--btn);color:var(--gold);border:1px solid var(--btnb);border-radius:12px;padding:10px 14px;cursor:pointer}
    nav button.active{background:linear-gradient(180deg, rgba(212,175,55,.20), rgba(212,175,55,.08)); border-color:var(--gold2); color:#fff}
    section{display:none}
    section.active{display:block}
    .card{background:linear-gradient(180deg,#131313,#0e0e0e);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 0 rgba(212,175,55,.08), 0 8px 40px rgba(0,0,0,.25)}
    label{display:block;margin:8px 0 6px}
    input,textarea,select{width:100%;border:1px solid var(--border);background:#0d0d0d;color:var(--text);border-radius:10px;padding:10px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border); padding:10px; text-align:left; font-size:14px}
    th{color:#f0e6c0}
    .muted{opacity:.85;font-size:12px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 300px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{background:var(--btn);color:var(--gold);border:1px solid var(--btnb);border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg, rgba(212,175,55,.22), rgba(212,175,55,.1)); border-color:var(--gold2); color:#fff}
    video{width:100%;max-height:360px;border-radius:14px;border:1px solid var(--border);background:#000}
    .small{font-size:12px}
    a{color:var(--gold)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 2px}
    .chip{background:var(--chip);border:1px solid var(--btnb);color:#d8c48a;border-radius:999px;padding:8px 12px;cursor:pointer}
    #err{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);color:#ffb4b4;z-index:9999;padding:16px;overflow:auto;border-top:2px solid #b00020}
    #err pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <div id="err"><strong>Erro de execução no app</strong><pre id="errlog"></pre><button onclick="this.parentElement.style.display='none'">Fechar</button></div>
  <header><h1><span class="brand">Zarya Finance</span> • NFC-e + OFX (PWA)</h1></header>
  <main>
    <nav>
      <button data-tab="scan" class="active">Scanner NFC-e</button>
      <button data-tab="receipts">Notas</button>
      <button data-tab="import">Importar OFX</button>
      <button data-tab="txs">Lançamentos</button>
      <button data-tab="reports">Relatórios</button>
      <button data-tab="settings">Config</button>
      <button data-tab="debug">Diagnóstico</button>
    </nav>

    <div class="card">
      <div class="chips">
        <span class="chip" id="chipMonth">Mês atual</span>
        <span class="chip" id="chip30">Últimos 30 dias</span>
        <span class="chip" id="chipYear">Ano atual</span>
      </div>
      <span class="muted small">Filtros de período afetam Tabelas e Relatórios.</span>
    </div>

    <section id="scan" class="active">
      <div class="card">
        <p class="muted">Use a câmera para ler o QR da NFC-e. Se o navegador não suportar, fotografe o QR, use o <span class="kbd">Leitor alternativo</span> ou cole a URL.</p>
        <div class="row">
          <div>
            <video id="video" playsinline></video>
            <div class="actions">
              <button id="btnStart" class="btn primary">Iniciar câmera (traseira)</button>
              <button id="btnSwitchCam" class="btn">Trocar câmera</button>
              <button id="btnStop" class="btn">Parar</button>
              <button id="btnZXing" class="btn">Leitor alternativo (ZXing)</button>
              <button id="btnSnap" class="btn">Ler de foto</button>
            </div>
            <p id="scanStatus" class="small muted">Status: inativo</p>
          </div>
          <div>
            <label for="qrUrl">Ou cole a URL do QR Code</label>
            <input id="qrUrl" placeholder="https://…">
            <div class="actions">
              <button id="btnProcessUrl" class="btn">Processar URL</button>
            </div>
            <p class="small muted">Dica: aponte a câmera nativa do iPhone para o QR e copie a URL que aparece.</p>
          </div>
        </div>
      </div>
      <div class="card"><h3>Resultado</h3><pre id="result" class="small"></pre></div>
    </section>

    <section id="receipts">
      <div class="card">
        <div class="actions">
          <button id="btnRefreshReceipts" class="btn">Atualizar</button>
          <button id="btnExportReceipts" class="btn">Exportar CSV</button>
        </div>
        <table id="tblReceipts">
          <thead><tr><th>Data</th><th>Emitente</th><th>Valor</th><th>Itens</th><th>UF</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="import">
      <div class="card">
        <label for="ofx">Arquivo OFX (Santander/Bradesco)</label>
        <input id="ofx" type="file" accept=".ofx">
        <div class="actions">
          <button id="btnImportOfx" class="btn primary">Importar</button>
          <button id="btnExportTxs" class="btn">Exportar CSV</button>
        </div>
        <p id="ofxStatus" class="small muted">Nenhum arquivo enviado.</p>
      </div>
    </section>

    <section id="txs">
      <div class="card">
        <table id="tblTxs">
          <thead><tr><th>Data</th><th>Desc</th><th>Valor</th><th>Tipo</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="reports">
      <div class="card">
        <h3>Relatórios</h3>
        <div class="row">
          <div><canvas id="chartMes" height="220"></canvas></div>
          <div><canvas id="chartCat" height="220"></canvas></div>
        </div>
        <p class="muted small">Crie regras para classificar automaticamente (aba Config).</p>
      </div>
    </section>

    <section id="settings">
      <div class="card">
        <h3>Configurações</h3>
        <label for="endpoint">Endpoint do Parser (Apps Script)</label>
        <input id="endpoint" placeholder="https://script.google.com/macros/s/AKfycb.../exec">
        <label>Modo do Parser</label>
        <div class="row">
          <label><input type="radio" name="parserMode" value="apps" checked> Apps Script (recomendado)</label>
          <label><input type="radio" name="parserMode" value="proxy"> Proxy Público (r.jina.ai)</label>
        </div>
        <label for="uf">UF padrão</label>
        <input id="uf" placeholder="MG">
        <div class="actions">
          <button id="btnSaveCfg" class="btn primary">Salvar</button>
          <button id="btnClearAll" class="btn">Apagar TUDO (local)</button>
        </div>
        <p id="cfgStatus" class="small muted"></p>
      </div>

      <div class="card">
        <h3>Regras de categorização</h3>
        <div class="row">
          <div><label>Padrão (regex)</label><input id="rulePattern" placeholder="mercado|super|carrefour"></div>
          <div><label>Categoria</label><input id="ruleCat" placeholder="Supermercado"></div>
        </div>
        <div class="actions"><button id="btnAddRule" class="btn">Adicionar regra</button></div>
        <table id="tblRules"><thead><tr><th>Padrão</th><th>Categoria</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="debug">
      <div class="card">
        <h3>Diagnóstico do Parser</h3>
        <p class="small muted">Cole a URL da NFC-e abaixo e clique em <b>Testar</b> para ver exatamente o que o parser leu (sem salvar).</p>
        <div class="row">
          <div><input id="dbgUrl" placeholder="https://..."></div>
        </div>
        <div class="actions">
          <button id="btnDbgTest" class="btn">Testar</button>
        </div>
        <pre id="dbgOut" class="small"></pre>
      </div>
    </section>
  </main>

  <noscript>Ative o JavaScript para usar o Zarya Finance.</noscript>

  <script>
    // Error overlay
    (function(){
      function showErr(msg, src, ln, col, err){
        var el=document.getElementById('err'); var pre=document.getElementById('errlog');
        if(!el||!pre) return;
        pre.textContent = (msg||'') + '\\n' + (src||'') + ':' + (ln||'?') + ':' + (col||'?') + (err?'\\n'+(err.stack||err):'');
        el.style.display='block';
      }
      window.addEventListener('error', function(e){ showErr(e.message, e.filename, e.lineno, e.colno, e.error); });
      window.addEventListener('unhandledrejection', function(e){ showErr('Unhandled: '+(e.reason && e.reason.message || e.reason), '', '', '', e.reason); });
    })();
  </script>

  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://unpkg.com/@zxing/library@latest"></script>
  <script defer src="store.js"></script>
  <script defer src="ofx.js"></script>
  <script defer src="nfce.js"></script>
  <script defer src="main.js"></script>
</body>
</html>
